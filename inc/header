#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

LOCKFILE="${BASE_PATH}/lock/${JOBNAME}.lock"
QUEUETIME=0

function teardown {
  EC=$?
  trap - EXIT
  
  if [ ${EC} -ne 0 ]
  then
    echo "❌ Backup '${JOBNAME}' 🛑 ${EC} 🗃 ${0} 📅 $(date) 🏁 $(${BASE_PATH}/bin/displaytime $((SECONDS - QUEUETIME)))."
  else
    echo "✅ Backup '${JOBNAME}' 📅 $(date) 🏁 $(${BASE_PATH}/bin/displaytime $((SECONDS - QUEUETIME)))."
  fi

  flock --unlock 200
}

exec 200>${LOCKFILE}
flock --wait 3600 200 || exit 7
echo $$ 1>&200

trap teardown EXIT SIGINT

echo -e "🎬 Backup '${JOBNAME}' 📅 $(date) ⌛️ $(${BASE_PATH}/bin/displaytime ${SECONDS})."
QUEUETIME=${SECONDS}
