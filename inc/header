#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

LOCKFILE="${BASE_PATH}/lock/${JOBNAME}.lock"

function teardown {
  EC=$?
  trap - EXIT
  
  if [ ${EC} -ne 0 ]
  then
    echo "❌ Backup '${JOBNAME}' with exitcode ${EC} in ${0} at $(date)."
  else
    echo "✅ Backup '${JOBNAME}' after $(${BASE_PATH}/bin/displaytime ${SECONDS}) at $(date)."
  fi
}
trap teardown EXIT SIGINT

exec 200>$LOCKFILE
flock -w 3600 200 || { echo "ERROR: Cant get file lock on ${LOCKFILE}" 1>&2; exit 1; }
echo $$ 1>&200

echo -e "🚛 Starting Backup '${JOBNAME}' at $(date) after $(${BASE_PATH}/bin/displaytime ${SECONDS}) of waiting time."
