#!/usr/bin/env bash

# example: 
# /mnt/.bkp/bin/backup-remote /mnt/data.disk/datenteich.share datenteich@192.168.152.11:/mnt/backups.disk/datenteich/ /mnt/backup.disk/datenteich.backups bms

# TODO: https://lincolnloop.com/blog/detecting-file-moves-renames-rsync/

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

# set BASE_PATH
BASE_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && cd .. && pwd)"

SRC=${1:-''}
DST_REMOTE=${2:-''}
DST_REMOTE_BACKUPDIR=${3:-''}
VPN_CONF=${4:-''}
DST_USER="$(echo "${DST_REMOTE}" | cut -d@ -f1)"
DST_HOST="$(echo "${DST_REMOTE}" | cut -d@ -f2 | cut -d: -f1)"
RSYNCOPTS="${RSYNCOPTS:-""}"


# exit trap
function teardown {
  trap - EXIT

  flock --unlock 200
}

exec 200>${BASE_PATH}/lock/backup-remote.lock
flock -n 200 || exit 7
echo $$ 1>&200

trap teardown EXIT SIGINT

if [ -n "${DST_REMOTE_BACKUPDIR}" ]
then
  RSYNCOPTS="${RSYNCOPTS} --protect-args --backup --backup-dir=${DST_REMOTE_BACKUPDIR%/}/$(date +%F-%H-%M-%S)/"
fi

if [ -n "${VPN_CONF}" ] && [ $(ping -W 5 -c 1 ${DST_HOST} > /dev/null; echo $?) -ne 0 ]
then
  echo "Cannot ping Host, connecting to VPN (Host: ${DST_HOST})" 1>&2
  /usr/sbin/vpnc-connect ${VPN_CONF}
fi

RSYNCOPTS="${RSYNCOPTS} --partial --compress" ${BASE_PATH}/bin/backup-rsync ${SRC} ${DST_REMOTE}

# remove locally deleted files on remote after 90 days
[ -n "${DST_REMOTE_BACKUPDIR}" ] \
  && ssh ${DST_USER}@${DST_HOST} \
    find ${DST_REMOTE_BACKUPDIR} -mindepth 1 -maxdepth 1 -type d -ctime 90 -exec "echo Deleting remote backup directory '{}' \;" -exec "rm -rf '{}' \;"

# grep itself is listed in top, that swhy we check for 1
if [ "$(top -cbn1 | grep ${DST_USER}@${DST_HOST} | wc -l)" -eq 1 ]
then
  /usr/sbin/vpnc-disconnect
fi
