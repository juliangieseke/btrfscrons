#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

RSYNCOPTS="${RSYNCOPTS:-""}"

# set some vars
BASE_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && cd .. && pwd)"
MAILTO="julian.gieseke@gmail.com"
LOGFILE="${BASE_PATH}/log/$(basename ${1}).$(printf '%x' $(date +%s%N)).log"
EC=0 
SUBSCRIPT=''

SUBSCRIPT=${1}
shift

# update logfilename if retry is passed as next script
if [ "${SUBSCRIPT}" == "retry" ]
then
  LOGFILE="${BASE_PATH}/log/$(basename ${1}).$(printf '%x' $(date +%s%N)).log"
fi

# run backup job
echo "ðŸŽ¬ ${SUBSCRIPT} $@ ðŸ“… $(date)" | tee ${LOGFILE}
${SUBSCRIPT} "$@" 2>&1 | tee -a ${LOGFILE}
EC=${PIPESTATUS[0]}

# send mail if failed
if [ ${EC} -ne 0 ]
then
  echo "âŒ ${SUBSCRIPT} $@ ðŸ›‘ ${EC} ðŸ“… $(date)"
  echo -e "Subject: âŒ Error ${EC} in ${SUBSCRIPT} $@\n\n$(cat ${LOGFILE})" | ssmtp ${MAILTO} || cat ${LOGFILE} 1>&2
else
  echo "âœ… ${SUBSCRIPT} $@ ðŸ“… $(date)" | tee -a ${LOGFILE}
fi

exit $EC
