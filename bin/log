#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

RSYNCOPTS="${RSYNCOPTS:-""}"

# set some vars
BASE_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && cd .. && pwd)"
MAILTO="julian.gieseke@gmail.com"
LOGFILE="${BASE_PATH}/log/$(basename ${1}).$(printf '%x' $(date +%s%N)).log"

if [ "${1}" == "retry" ]
then
  LOGFILE="${BASE_PATH}/log/$(basename ${2}).$(printf '%x' $(date +%s%N)).log"
fi

[ ! -f "${LOGFILE}" ] && touch ${LOGFILE}

#first param is subscript name
SUBSCRIPT=${1}

#remove first parameter from list
shift

# run backup job
annotate-output '+%F %T' ${SUBSCRIPT} "$@" > >(tee -a ${LOGFILE}) 2> >(tee -a ${LOGFILE} >&1) \
  || echo -e "Subject: ‚ùå Error in $(basename ${SUBSCRIPT}) $@\n\n$(cat ${LOGFILE})" | ssmtp ${MAILTO} \
  || cat ${LOGFILE}
