#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

SRC=${1:-''}
DST_SNAP=${2:-''}
CRONTYPE=${3:-'hourly'}

SNAPSHOTNAME="$(date '+%F-%H-%M-%S')-${CRONTYPE}"
[ -d "${DST_SNAP%/}/${SNAPSHOTNAME}" ] && ( echo "ERROR: '${SNAPSHOTNAME}' already exists." 1>&2; exit 1 )

# update timestamp, fails if SRC is ""
touch ${SRC}

echo "ðŸ“¸ Create snapshot '${SNAPSHOTNAME}'"
btrfs subvolume snapshot -r "${SRC}" "${DST_SNAP%/}/${SNAPSHOTNAME}" > /dev/null
