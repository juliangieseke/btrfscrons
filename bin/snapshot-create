#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

JOBNAME=${1:-''}
SRC=${2:-''}
DST=${3:-''}

# gets $JOBNAME
# sets $JOBTYPE
source ${BASE_PATH}/inc/jobtype

# gets $JOBTYPE
# sets $KEEPDAYS
source ${BASE_PATH}/inc/keepdays



SNAPSHOTNAME="$(date '+%F-%H-%M-%S')-${JOBTYPE}"
[ -d "${DST%/}/${SNAPSHOTNAME}" ] && ( echo "ERROR: '${SNAPSHOTNAME}' already exists."; exit 1 )

# update timestamp, fails if SRC is ""
touch ${SRC}

btrfs subvolume snapshot -r "${SRC}" "${DST%/}/${SNAPSHOTNAME}"
