#!/usr/bin/env bash

set -e
trap 'exit 1' SIGINT

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

# set SCRIPT_PATH
SCRIPT_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && pwd)"

JOBTYPE=${1:-''}
SRC=${2:-''}
DST_SNAP=${3:-''}
DST_SEND=${4:-''}
DST_REMOTE=${5:-''}
DST_REMOTE_BACKUPDIR=${6:-''}
VPN_CONF=${7:-''}

# run local backup
FAILED=1
ATTEMPT=1
while [ ${FAILED} -ne 0 ] && [ ${ATTEMPT} -le 3 ]
do
  ${SCRIPT_PATH}/sendrecv ${DST_SNAP} ${DST_SEND} ${JOBTYPE} && FAILED=0 || FAILED=1
  [ ${FAILED} -ne 0 ] && echo "sendrecv failed, trying again (${ATTEMPT}/3)." 1>&2
  ATTEMPT=$[ATTEMPT+1]
done
[ ${FAILED} -ne 0 ] && exit 1

# run remote backup
FAILED=1
ATTEMPT=1
while [ ${FAILED} -ne 0 ] && [ ${ATTEMPT} -le 3 ]
do
  ${SCRIPT_PATH}/backup-remote ${SRC} ${DST_REMOTE} ${DST_REMOTE_BACKUPDIR} ${VPN_CONF} && FAILED=0 || FAILED=1
  [ ${FAILED} -ne 0 ] && echo "backup-remote failed, trying again (${ATTEMPT}/3)." 1>&2
  ATTEMPT=$[ATTEMPT+1]
done
[ ${FAILED} -ne 0 ] && exit 1