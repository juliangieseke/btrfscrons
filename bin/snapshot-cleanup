#!/usr/bin/env bash

# example: 
# /mnt/.bkp/bin/snapshot-cleanup /mnt/data.disk/datenteich.snapshots

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

DST=${1:-''}

BASE_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && cd .. && pwd)"

JOBTYPES=( hourly daily weekly monthly )
for JOBTYPE in "${JOBTYPES[@]}"
do
    KEEPDAYS=$(${BASE_PATH}/bin/get-keepdays-for-jobtype ${JOBTYPE})
    find "${DST%/}/" -maxdepth 1 -type d -name "*${JOBTYPE}*" -ctime +${KEEPDAYS} -exec ${BASE_PATH}/bin/snapshot-delete '{}' \;
done