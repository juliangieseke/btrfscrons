#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

# set SCRIPT_PATH
SCRIPT_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && pwd)"

SUBVOLUME=${1:-''}
CRONTYPE=${2:-'hourly'}
KEEPDAYS=${3:-'1'}

if [ ${KEEPDAYS} -gt 0 ]
then
  echo "Cleanup ${CRONTYPE} snapshots"
  find "${SUBVOLUME}.snapshots/" -maxdepth 1 -type d -name "*-${CRONTYPE}" -ctime ${KEEPDAYS} -exec ${SCRIPT_PATH}/snapshot-delete '{}' \;
else
  echo "Cleanup disabled for ${CRONTYPE}"
fi