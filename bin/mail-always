#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

RSYNCOPTS="${RSYNCOPTS:-""}"

# set some vars
BASE_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && cd .. && pwd)"
LOGFILE="${BASE_PATH}/log/$(date +%Y%m%d%-H%M%S).${1}.$(basename --suffix=.snapshots "${2}").log"
MAILTO="julian.gieseke@gmail.com"

# some checks
[ ! -f "${LOGFILE}" ] && touch ${LOGFILE}

#first param is subscript name
SUBSCRIPT=${1}

#remove first parameter from list
shift

# run backup job
annotate-output '+%F %T' ${SUBSCRIPT} "$@" > >(tee -a ${LOGFILE}) 2> >(tee -a ${LOGFILE} >&1) \
  && echo -e "Subject: ✅ Finished $(basename ${SUBSCRIPT}) $@\n\n$(cat ${LOGFILE})" | ssmtp ${MAILTO} \
  || echo -e "Subject: ❌ Error in $(basename ${SUBSCRIPT}) $@\n\n$(cat ${LOGFILE})" | ssmtp ${MAILTO} \
  || cat ${LOGFILE}
