#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

err_report() {
  echo "errexit on line $(caller)" >&2
}
trap err_report ERR

# set SCRIPT_PATH
SCRIPT_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && pwd)"

MAILTO="julian.gieseke@gmail.com"
MAILBODY="${SCRIPT_PATH}/mail.txt"

# reset file contents with subject & motd
echo -e "Todays System Report for $(hostname)\n\n=======================================\n" > ${MAILBODY}
cat /var/run/motd.dynamic >> ${MAILBODY}
echo -e "=======================================\n\n" >> ${MAILBODY}

# get the last lines of cron logfiles
find ${SCRIPT_PATH}/log -mindepth 1 -maxdepth 1 -type f -name "cron.*.log" | \
  while read LOGFILE
  do
    echo -e "Exitcodes in $(basename ${LOGFILE})\n$(cat ${LOGFILE} | grep 'Finished with exitcode')\n\n" >> ${MAILBODY}
  done

echo -e ============================================== "\n" >> ${MAILBODY}

${SCRIPT_PATH}/reports/disks.$(hostname | tr '[:upper:]' '[:lower:]') >> ${MAILBODY}

echo -e "\n" ============================================== "\n" >> ${MAILBODY}


# send mail with all remaining logfiles as attachements
cat ${MAILBODY} | mutt -s "System Report for $(hostname)" -a ${SCRIPT_PATH}/log/*.log -- $MAILTO

# delete old logs: 
find ${SCRIPT_PATH}/log -name '*.log' -mtime +2 | \
  while read LOGFILE
  do
    echo -n "Deleting old logfile $(basename $LOGFILE)â€¦ "
    rm '$LOGFILE'
    echo "done."
  done