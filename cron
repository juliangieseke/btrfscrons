#!/usr/bin/env bash

set -e

DEBUG=${DEBUG:-''}
[ -n "${DEBUG}" ] && set -x

err_report() {
  echo "errexit on line $(caller)" >&2
}
trap err_report ERR

# set SCRIPT_PATH
SCRIPT_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && pwd)"

JOBNAME="${1:-''}"
LOGFILE="${SCRIPT_PATH}/log/job-${JOBNAME}.log"
SUBSCRIPT="${SCRIPT_PATH}/jobs/${JOBNAME}"

MAILTO="julian.gieseke@gmail.com"

[ -z "${SUBSCRIPT}" ] && echo "ERROR: No \$SUBSCRIPT given" && exit 1;

[ ! -f "${LOGFILE}" ] && touch ${LOGFILE}

${SUBSCRIPT} 1>>${LOGFILE} 2>>${LOGFILE} \
  || echo -e "Subject: ❌ Error on Job '$(basename ${SUBSCRIPT})'\n\n$(tac ${LOGFILE} | grep -m1 -B50000 🚛 | tail -n 100)" | ssmtp ${MAILTO} \
  || tail -n 100 ${LOGFILE}
